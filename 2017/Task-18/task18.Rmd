---
params:
   task_nr: 18
   year: 2017
title: '`r paste("<span>Task", params$task_nr, "<span class = \"back\"><a href = \"index.html\">", fontawesome::fa("home"), "</a></span></span>")`'
author: 
  name: "Thorn Thaler"
  email: "thorn.thaler@thothal.at"
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) {
   year <- basename(dirname(dirname(inputFile)))
   
   o_file <- sprintf("%s_%s", year, 
                     tools::file_path_sans_ext(basename(inputFile)))
                     
   rmarkdown::render(inputFile, encoding = encoding, 
                     output_file = o_file, output_dir = here::here("docs"))
   })
output: 
  rmdformats::downcute:
    highlight: tango
    use_bookdown: TRUE
    mathjax: NULL
    lightbox: TRUE
    gallery: TRUE
editor_options: 
  chunk_output_type: console
---

```{css custom-css, echo = FALSE}
.page-content  .figure {
  width: 100%;
}

.back {
  font-size: 2rem;
}

.day-desc {
  border: 2px dotted;
  border-radius: 6px;
  border-color: var(--blockquote-border-color);
  padding: 0 20px;
}

.page-content table tr pre {
  border-radius: revert;
  background-color: revert;
  color: revert;
  padding: revert;
  border: revert;
}
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, fig.align = "center",
                      dev.args = list(bg = "transparent"))
## Define a function to write text in typewriter font
tt <- function(x) {
  if (knitr::is_latex_output()) {
    sprintf("\\texttt{%s}", as.character(x))
  } else if (knitr::is_html_output()) {
    sprintf("<tt>%s</tt>", as.character(x))
  } else {
    x
  }
}

```

# Setup

## Libraries

```{r libs, warning = FALSE}
library(httr)
library(xml2)
library(magrittr)
library(dplyr)
library(purrr)
library(stringr)
library(kableExtra)
```

## Retrieve Data from `r tt("AoC")`


```{r get-data, cache = FALSE, messages = FALSE}
session_cookie <- set_cookies(session = keyring::key_get("AoC-GitHub-Cookie"))
base_url <- paste0("https://adventofcode.com/", params$year, "/day/", params$task_nr)
puzzle <- GET(base_url,
              session_cookie) %>% 
  content(encoding = "UTF-8") %>% 
  xml_find_all("///article") %>% 
  lapply(as.character)

parse_puzzle_data <- function(text_block = readClipboard()) {
  if (length(text_block) == 1L) {
    text_block <- text_block %>% 
      str_split("\n") %>% 
      extract2(1L) %>% 
      keep(nzchar)
  }
  text_block %>% 
    str_split(" ") %>% 
    map(~ c(.x, NA_character_)[1:3]) %>% 
    do.call(rbind, .) %>% 
    set_colnames(c("op", "arg1", "arg2")) %>% 
    as_tibble() %>% 
    mutate(op_original = text_block, .before = 1L)
}

puzzle_data <- local({
  GET(paste0(base_url, "/input"),
      session_cookie) %>% 
    content(encoding = "UTF-8") %>% 
    parse_puzzle_data()
})
```

```{r example-data, eval = interactive(), echo = FALSE}
```

# Puzzle Day `r params$task_nr`

## Part 1

### Description

```{r show-puzzle-a, echo = FALSE, results = "asis"}
cat(puzzle[[1]])
```

### Solution

To solve the first part of the puzzle let's have a look at the lines `1--28`:

```{r show-ops}
puzzle_data %>% 
  slice(1:26) %>% 
  select(Instruction = op_original) %>% 
  mutate(Loops = rep(c("", "<--+", "   |", "---+", "", "<--+", "   |", "---+", "-----+",
                   "<-+  |", "--+  |", "<----+", ""), 
                   c(4L, 1L, 1L, 1L, 3L, 1L, 8L, 1L, 1L, 1L, 1L, 1L, 2L))) %>% 
  mutate(Loops = paste0("<pre>", Loops, "</pre>")) %>% 
  kbl(escape = FALSE, row.names = TRUE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE) %>% 
  column_spec(2, monospace = TRUE)
```

We see that lines 1 to 20 form a setup block, where registers are set. We also note, that 
register `a` equals `2 ^ 31 - 1`. The sound is set in the loop with the frequency derived 
from the given instructions.

After the loop end in line 20, we jump **conditionally** on `a`. Since `a` is **not** zero
at this atge, we will **always** continue with line 24 and we eventually hit line 26 which
will return the frequency set in the loop.

Thus, all we need to do is to implement the first loop to get the deisred frequency.



```{r get-solution-1}
get_frequency <- function() {
  p <- 464L
  a <- 2L ^ 31L - 1L
  for (i in 1:127) {
    p <- (((p * 8505) %% a) * 129749 + 12345) %% a 
    res <- p %% 10000
    
  }
  res
}
get_frequency()
```

## Part 2

### Description

```{r show-puzzle-b, echo = FALSE, results = "asis", eval = length(puzzle) > 1}
cat(puzzle[[2]])
```

### Solution

```{r get-solution-2, cache = TRUE}

```
