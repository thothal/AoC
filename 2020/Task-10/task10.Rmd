---
params:
   task_nr: 10
   year: 2020
title: '`r paste("<span>Task", params$task_nr, "<span class = \"back\"><a href = \"index.html\">", fontawesome::fa("home"), "</a></span></span>")`'
author: 
  name: "Thorn Thaler"
  email: "thorn.thaler@thothal.at"
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) {
   year <- basename(dirname(dirname(inputFile)))
   
   o_file <- sprintf("%s_%s", year, 
                     tools::file_path_sans_ext(basename(inputFile)))
                     
   rmarkdown::render(inputFile, encoding = encoding, 
                     output_file = o_file, output_dir = here::here("docs"))
   })
output: 
  rmdformats::downcute:
    highlight: tango
    use_bookdown: TRUE
    mathjax: NULL
    lightbox: TRUE
    gallery: TRUE
editor_options: 
  chunk_output_type: console
---

```{css custom-css, echo = FALSE}
.page-content  .figure {
  width: 100%;
}

.back {
  font-size: 2rem;
}

.day-desc {
  border: 2px dotted;
  border-radius: 6px;
  border-color: var(--blockquote-border-color);
  padding: 0 20px;
}
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, fig.align = "center",
                      dev.args = list(bg = "transparent"))
## Define a function to write text in typewriter font
tt <- function(x) {
  if (knitr::is_latex_output()) {
    sprintf("\\texttt{%s}", as.character(x))
  } else if (knitr::is_html_output()) {
    sprintf("<tt>%s</tt>", as.character(x))
  } else {
    x
  }
}

```

# Setup

## Libraries

```{r libs, warning = FALSE}
library(httr)
library(xml2)
library(magrittr)
library(dplyr)
library(purrr)
library(stringr)
library(igraph)
library(bit64)
```

## Retrieve Data from `r tt("AoC")`


```{r get-data, cache = FALSE, messages = FALSE}
session_cookie <- set_cookies(session = keyring::key_get("AoC-GitHub-Cookie"))
base_url <- paste0("https://adventofcode.com/", params$year, "/day/", params$task_nr)
puzzle <- GET(base_url,
              session_cookie) %>% 
  content(encoding = "UTF-8") %>% 
  xml_find_all("///article") %>% 
  lapply(as.character)

parse_puzzle_data <- function(text_block = readClipboard()) {
  if (length(text_block) == 1L) {
    text_block <- text_block %>% 
      str_split("\n") %>% 
      extract2(1L) %>% 
      keep(nzchar)
  }
  text_block %>% 
    as.integer()
}

puzzle_data <- local({
  GET(paste0(base_url, "/input"),
      session_cookie) %>% 
    content(encoding = "UTF-8") %>% 
    parse_puzzle_data()
})
```

```{r example-data, eval = interactive(), echo = FALSE}
```

# Puzzle Day `r params$task_nr`

## Part 1

### Description

```{r show-puzzle-a, echo = FALSE, results = "asis"}
cat(puzzle[[1]])
```

### Solution

We sort the adapters according to their joltage, add the charging outlet to the beginning 
and the device adaptor to the end, form the differences, count them and multiply them to 
get the answer.

```{r get-solution-1}
get_joltage_kpi <- function(adapters) {
  joltages <- sort(adapters)
  c(0L, joltages, max(joltages) + 3L) %>% 
    diff() %>% 
    table() %>% 
    prod()
}
get_joltage_kpi(puzzle_data)  
```

## Part 2

### Description

```{r show-puzzle-b, echo = FALSE, results = "asis", eval = length(puzzle) > 1}
cat(puzzle[[2]] %>% str_replace_all(fixed("*"), "\\*"))
```

### Solution

We construct a graph, where each adaptor connects to any valid adapter. Then we use 
dynamic programming to count all paths between the outlet and the device.

```{r get-solution-2}
construct_graph <- function(adapters) {
  joltages <- sort(adapters)
  joltages <- c(0L, joltages, max(joltages) + 3L)
  edges <- expand.grid(from = joltages, to = joltages) %>% 
    filter(to - from <= 3L, to - from >= 1L)
  graph_from_data_frame(edges)
}

G <- construct_graph(puzzle_data)

count_paths <- function(G) {
  from <- "0"
  to <- "152"
  order <- topo_sort(G, mode = "out")
  id <- as.integer(order)
  dp <- set_names(integer64(vcount(G)), 
                  V(G)$name)
  dp[from] <- 1L
  for (u in id) {
    u_name <- V(G)$name[u]
    if (dp[u_name] == 0L) {
      next
    }
    for (v in neighbors(G, u, mode = "out")) {
      dp[V(G)$name[v]] <- dp[V(G)$name[v]] + dp[u_name]
    }
  }
  dp[to]
}

count_paths(G)
```
